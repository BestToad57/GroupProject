@model IEnumerable<GroupProject.Code.Models.Comment>
@{
    ViewData["Title"] = "Comments";
    var episode = ViewBag.Episode as GroupProject.Code.Models.Episode;
    var podcast = ViewBag.Podcast as GroupProject.Code.Models.Podcast;
    var currentUserId = ViewBag.CurrentUserId as string;
    var isPodcaster = ViewBag.IsPodcaster ?? false;
    var isAdmin = ViewBag.IsAdmin ?? false;
}

<div class="container my-4">
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Episode Info -->
    <div class="card shadow-lg mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1 text-white">
                        <i class="fas fa-play-circle me-2"></i>@episode?.Title
                    </h3>
                    <p class="mb-0 text-muted">
                        <i class="fas fa-podcast me-1"></i>@podcast?.Title
                    </p>
                </div>
                <a asp-controller="Episode" asp-action="Details" asp-route-id="@episode?.EpisodeID" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>Back to Episode
                </a>
            </div>
        </div>
    </div>

    <!-- Add Comment Form -->
    <div class="card shadow-lg mb-4">
        <div class="card-header">
            <h4 class="mb-0 text-white">
                <i class="fas fa-comment-medical me-2"></i>Add a Comment
            </h4>
        </div>
        <div class="card-body">
            <form asp-action="Add" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="episodeId" value="@episode?.EpisodeID" />
                
                <div class="mb-3">
                    <textarea name="commentText" class="form-control" rows="4" 
                              placeholder="Share your thoughts about this episode..." required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane me-2"></i>Post Comment
                </button>
            </form>
        </div>
    </div>

    <!-- Comments List -->
    <div class="card shadow-lg">
        <div class="card-header">
            <h4 class="mb-0 text-white">
                <i class="fas fa-comments me-2"></i>Comments
                <span class="badge bg-light text-dark ms-2">@Model.Count()</span>
            </h4>
        </div>
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var comment in Model)
                    {
                        var isOwner = comment.UserID == currentUserId;
                        var canDelete = isAdmin || isPodcaster || isOwner;

                        <div class="list-group-item bg-transparent border-secondary mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-user-circle fa-2x me-2" style="color: var(--primary-red);"></i>
                                        <div>
                                            <h6 class="mb-0 text-light">
                                                @comment.UserID
                                                @if (isOwner)
                                                {
                                                    <span class="badge bg-info ms-2">You</span>
                                                }
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>
                                                @comment.CommentDate.ToString("MMM dd, yyyy 'at' hh:mm tt")
                                            </small>
                                        </div>
                                    </div>
                                    <p class="mb-0 text-light">@comment.CommentText</p>
                                </div>
                                
                                @if (canDelete || isOwner)
                                {
                                    <div class="btn-group ms-3" role="group">
                                        @if (isOwner)
                                        {
                                            <a asp-action="Edit" asp-route-id="@comment.CommentID" 
                                               class="btn btn-sm btn-outline-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        }
                                        @if (canDelete)
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteModal-@comment.CommentID"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-comments text-muted mb-3" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h5 class="text-muted">No comments yet</h5>
                    <p class="text-muted">Be the first to comment on this episode!</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modals (moved outside to prevent positioning issues) -->
@if (Model != null && Model.Any())
{
    @foreach (var comment in Model)
    {
        var isOwner = comment.UserID == currentUserId;
        var canDelete = isAdmin || isPodcaster || isOwner;
        
        @if (canDelete)
        {
            <div class="modal fade" id="deleteModal-@comment.CommentID" tabindex="-1" aria-labelledby="deleteModalLabel-@comment.CommentID" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="background-color: var(--medium-gray); border: 2px solid var(--primary-red);">
                        <div class="modal-header" style="border-bottom: 1px solid var(--primary-red);">
                            <h5 class="modal-title text-light" id="deleteModalLabel-@comment.CommentID">
                                <i class="fas fa-exclamation-triangle me-2" style="color: var(--primary-red);"></i>
                                Confirm Delete
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-light">
                            <p>Are you sure you want to delete this comment?</p>
                            <p class="text-danger">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                This action cannot be undone!
                            </p>
                        </div>
                        <div class="modal-footer" style="border-top: 1px solid var(--primary-red);">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form asp-action="Delete" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@comment.CommentID" />
                                <input type="hidden" name="episodeId" value="@episode?.EpisodeID" />
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash me-1"></i>Delete Comment
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}